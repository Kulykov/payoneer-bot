import logging
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor

# ------------------ CONFIG ------------------
BOT_TOKEN = "8597805865:AAFGXE9bbagglv4PiHDslhWSnPVZmp-1TAo"
CRYPTOBOT_API_KEY = "495380:AAAdvdXSd121op9T5cGDVSgG8iQXZMjhOLO"

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)
logging.basicConfig(level=logging.INFO)

# ------------------ KEYBOARDS ------------------
def main_menu():
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üõí –ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã", callback_data="buy_accounts"))
    return kb


def accounts_menu():
    kb = InlineKeyboardMarkup(row_width=2)

    for i in range(1, 11):
        kb.insert(InlineKeyboardButton(f"{i} –∞–∫–∫–∞—É–Ω—Ç(–æ–≤) ‚Äî ${i*10}", callback_data=f"acc_{i}"))

    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_main"))
    return kb


# ------------------ PAYMENT (CryptoBot API) ------------------
import requests


def create_invoice(amount, description="–ü–æ–∫—É–ø–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤", asset="USDT"):
    url = "https://pay.crypt.bot/api/createInvoice"
    headers = {"Crypto-Pay-API-Token": CRYPTOBOT_API_KEY}
    payload = {
        "amount": amount,
        "asset": asset,
        "description": description
    }
    r = requests.post(url, json=payload, headers=headers).json()
    return r["result"]["pay_url"]


# ------------------ HANDLERS ------------------
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω –∞–∫–∫–∞—É–Ω—Ç–æ–≤.\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é –Ω–∏–∂–µ:",
        reply_markup=main_menu()
    )


@dp.callback_query_handler(lambda c: c.data == "buy_accounts")
async def show_accounts(call: types.CallbackQuery):
    await call.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:",
        reply_markup=accounts_menu()
    )


@dp.callback_query_handler(lambda c: c.data.startswith("acc_"))
async def select_amount(call: types.CallbackQuery):
    count = int(call.data.split("_")[1])
    price = count * 10

    pay_url = create_invoice(price, description=f"–ü–æ–∫—É–ø–∫–∞ {count} –∞–∫–∫–∞—É–Ω—Ç–æ–≤")

    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=pay_url))
    kb.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="buy_accounts"))
    kb.add(InlineKeyboardButton("üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_main"))

    await call.message.edit_text(
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: {count} –∞–∫–∫–∞—É–Ω—Ç(–æ–≤)\n–°—Ç–æ–∏–º–æ—Å—Ç—å: ${price}\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ:",
        reply_markup=kb
    )


@dp.callback_query_handler(lambda c: c.data == "back_main")
async def go_main(call: types.CallbackQuery):
    await call.message.edit_text(
        "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:", reply_markup=main_menu()
    )


# ------------------ RUN ------------------
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
